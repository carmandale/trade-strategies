<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPY Spread Strategies Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid #1a237e;
        }
        
        h1 {
            color: #64b5f6;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .current-price {
            font-size: 1.5em;
            color: #4fc3f7;
        }
        
        .controls {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-item {
            display: flex;
            flex-direction: column;
        }
        
        label {
            color: #90caf9;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, select {
            padding: 10px;
            border: 1px solid #3f51b5;
            border-radius: 5px;
            background: #0d1929;
            color: #e0e0e0;
            font-size: 16px;
        }
        
        input[type="range"] {
            margin-top: 5px;
        }
        
        .strike-inputs {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        
        .strike-inputs input {
            flex: 1;
        }
        
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #1976d2;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .strategy-card {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #3f51b5;
        }
        
        .strategy-card h3 {
            color: #64b5f6;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 5px 0;
            border-bottom: 1px solid #263238;
        }
        
        .metric-label {
            color: #90caf9;
        }
        
        .metric-value {
            font-weight: bold;
        }
        
        .profit {
            color: #4caf50;
        }
        
        .loss {
            color: #f44336;
        }
        
        #chart {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            height: 400px;
        }
        
        .trade-log {
            background: #1a1f3a;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .trade-log h2 {
            color: #64b5f6;
            margin-bottom: 15px;
        }
        
        .trade-entry {
            background: #0d1929;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .trade-info {
            flex: 1;
        }
        
        .trade-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .btn-danger {
            background: #f44336;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #90caf9;
        }
        
        .error {
            background: #b71c1c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .recommendation {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-weight: 500;
        }
        
        .favorable {
            background: #1b5e20;
            color: #a5d6a7;
        }
        
        .unfavorable {
            background: #b71c1c;
            color: #ef9a9a;
        }
        
        .neutral {
            background: #37474f;
            color: #cfd8dc;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SPY Spread Strategies Tool</h1>
            <div class="current-price" id="currentPrice">Loading current price...</div>
        </header>
        
        <div class="controls">
            <div class="control-group">
                <div class="control-item">
                    <label for="date">Analysis Date</label>
                    <input type="date" id="date" value="">
                </div>
                
                <div class="control-item">
                    <label for="contracts">Contracts</label>
                    <input type="number" id="contracts" value="200" min="1">
                </div>
                
                <div class="control-item">
                    <label for="entryTime">Entry Time</label>
                    <input type="time" id="entryTime" value="08:30">
                </div>
                
                <div class="control-item">
                    <label for="exitTime">Exit Time</label>
                    <input type="time" id="exitTime" value="14:30">
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-item">
                    <label>Bull Call Strikes (Lower - Upper)</label>
                    <div class="strike-inputs">
                        <input type="number" id="bullCall1" value="637" step="1" placeholder="Lower">
                        <input type="number" id="bullCall2" value="640" step="1" placeholder="Upper">
                    </div>
                </div>
                
                <div class="control-item">
                    <label>Iron Condor Strikes (Put: Short/Long - Call: Short/Long)</label>
                    <div class="strike-inputs" style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px;">
                        <input type="number" id="ironCondor1" value="633" step="1" placeholder="Put Short" title="Put Short Strike">
                        <input type="number" id="ironCondor3" value="631" step="1" placeholder="Put Long" title="Put Long Strike">
                        <input type="number" id="ironCondor2" value="638" step="1" placeholder="Call Short" title="Call Short Strike">
                        <input type="number" id="ironCondor4" value="640" step="1" placeholder="Call Long" title="Call Long Strike">
                    </div>
                </div>
                
                <div class="control-item">
                    <label>Butterfly Strikes (Lower - Body - Upper)</label>
                    <div class="strike-inputs">
                        <input type="number" id="butterfly1" value="637" step="1" placeholder="Lower">
                        <input type="number" id="butterfly2" value="638" step="1" placeholder="Body">
                        <input type="number" id="butterfly3" value="639" step="1" placeholder="Upper">
                    </div>
                </div>
            </div>
            
            <button onclick="analyzeStrategies()">Analyze Strategies</button>
        </div>
        
        <div id="results" class="results"></div>
        
        <canvas id="chart"></canvas>
        
        <div class="trade-log">
            <h2>Trade Log</h2>
            <div id="tradeList"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chart = null;
        let currentAnalysis = null;
        
        // Set default date to today
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        
        // Load current price on startup
        async function loadCurrentPrice() {
            try {
                const response = await fetch('/current_price/SPY');
                const data = await response.json();
                document.getElementById('currentPrice').textContent = `Current SPY: $${data.price.toFixed(2)}`;
            } catch (error) {
                console.error('Error loading current price:', error);
            }
        }
        
        // Analyze strategies
        async function analyzeStrategies() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Analyzing strategies...</div>';
            
            const requestData = {
                date: document.getElementById('date').value,
                contracts: parseInt(document.getElementById('contracts').value),
                bull_call_strikes: [
                    parseFloat(document.getElementById('bullCall1').value),
                    parseFloat(document.getElementById('bullCall2').value)
                ],
                iron_condor_strikes: [
                    parseFloat(document.getElementById('ironCondor1').value),
                    parseFloat(document.getElementById('ironCondor2').value),
                    parseFloat(document.getElementById('ironCondor3').value),
                    parseFloat(document.getElementById('ironCondor4').value)
                ],
                butterfly_strikes: [
                    parseFloat(document.getElementById('butterfly1').value),
                    parseFloat(document.getElementById('butterfly2').value),
                    parseFloat(document.getElementById('butterfly3').value)
                ],
                entry_time: document.getElementById('entryTime').value + ':00',
                exit_time: document.getElementById('exitTime').value + ':00'
            };
            
            console.log('Sending request data:', requestData);
            
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                currentAnalysis = data;
                displayResults(data);
                updateChart(data.chart_data);
            } catch (error) {
                console.error('Analysis error:', error);
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
        
        // Display results
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const strategies = ['bull_call', 'iron_condor', 'butterfly'];
            const strategyNames = {
                'bull_call': 'Bull Call Spread',
                'iron_condor': 'Iron Condor',
                'butterfly': 'Butterfly Spread'
            };
            
            resultsDiv.innerHTML = strategies.map(strategy => {
                const result = data.results[strategy];
                const profit = result.profit_at_exit;
                const profitClass = profit >= 0 ? 'profit' : 'loss';
                
                // Get strike values for display
                let strikes = '';
                if (strategy === 'bull_call') {
                    strikes = `${document.getElementById('bullCall1').value}-${document.getElementById('bullCall2').value}`;
                } else if (strategy === 'iron_condor') {
                    strikes = `${document.getElementById('ironCondor1').value}/${document.getElementById('ironCondor3').value} - ${document.getElementById('ironCondor2').value}/${document.getElementById('ironCondor4').value}`;
                } else {
                    strikes = `${document.getElementById('butterfly1').value}-${document.getElementById('butterfly2').value}-${document.getElementById('butterfly3').value}`;
                }
                
                // Determine recommendation
                let recommendation = '';
                let recommendationClass = 'neutral';
                
                if (strategy === 'bull_call') {
                    if (data.current_price < parseFloat(document.getElementById('bullCall1').value)) {
                        recommendation = 'FAVORABLE - Price below lower strike';
                        recommendationClass = 'favorable';
                    } else if (data.current_price > parseFloat(document.getElementById('bullCall2').value)) {
                        recommendation = 'UNFAVORABLE - Price above upper strike';
                        recommendationClass = 'unfavorable';
                    } else {
                        recommendation = 'NEUTRAL - Price between strikes';
                    }
                } else if (strategy === 'iron_condor') {
                    const lower = parseFloat(document.getElementById('ironCondor1').value);
                    const upper = parseFloat(document.getElementById('ironCondor2').value);
                    if (data.current_price > lower && data.current_price < upper) {
                        recommendation = 'FAVORABLE - Price within profit zone';
                        recommendationClass = 'favorable';
                    } else {
                        recommendation = 'UNFAVORABLE - Price outside profit zone';
                        recommendationClass = 'unfavorable';
                    }
                } else {
                    const center = parseFloat(document.getElementById('butterfly2').value);
                    const distance = Math.abs(data.current_price - center);
                    if (distance < 0.5) {
                        recommendation = `HIGHLY FAVORABLE - $${distance.toFixed(2)} from center`;
                        recommendationClass = 'favorable';
                    } else if (distance < 1.5) {
                        recommendation = `FAVORABLE - $${distance.toFixed(2)} from center`;
                        recommendationClass = 'favorable';
                    } else {
                        recommendation = `UNFAVORABLE - $${distance.toFixed(2)} from center`;
                        recommendationClass = 'unfavorable';
                    }
                }
                
                return `
                    <div class="strategy-card">
                        <h3>${strategyNames[strategy]}</h3>
                        <div class="metric">
                            <span class="metric-label">Strikes:</span>
                            <span class="metric-value">${strikes}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">P/L at Exit:</span>
                            <span class="metric-value ${profitClass}">$${profit.toFixed(2)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Max Profit:</span>
                            <span class="metric-value profit">$${result.max_profit.toFixed(2)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Max Loss:</span>
                            <span class="metric-value loss">$${result.max_loss.toFixed(2)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Entry Price:</span>
                            <span class="metric-value">$${result.entry_price.toFixed(2)}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Exit Price:</span>
                            <span class="metric-value">$${result.exit_price.toFixed(2)}</span>
                        </div>
                        <div class="recommendation ${recommendationClass}">
                            ${recommendation}
                        </div>
                        <button class="btn-small" onclick="logTrade('${strategy}', '${strikes}', ${profit})">
                            Log Trade
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        // Update chart
        function updateChart(chartData) {
            const ctx = document.getElementById('chart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.time),
                    datasets: [{
                        label: 'SPY Price',
                        data: chartData.map(d => d.price),
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'BB Upper',
                        data: chartData.map(d => d.bb_upper),
                        borderColor: '#4caf50',
                        borderDash: [5, 5],
                        fill: false
                    }, {
                        label: 'BB Lower',
                        data: chartData.map(d => d.bb_lower),
                        borderColor: '#f44336',
                        borderDash: [5, 5],
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'SPY Price Chart',
                            color: '#90caf9'
                        },
                        legend: {
                            labels: {
                                color: '#90caf9'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#90caf9'
                            },
                            grid: {
                                color: '#263238'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#90caf9'
                            },
                            grid: {
                                color: '#263238'
                            }
                        }
                    }
                }
            });
        }
        
        // Log trade
        async function logTrade(strategy, strikes, profit) {
            const trade = {
                date: document.getElementById('date').value,
                strategy: strategy,
                strikes: strikes.split('-').map(s => parseFloat(s)),
                contracts: parseInt(document.getElementById('contracts').value),
                entry_price: currentAnalysis.results[strategy].entry_price,
                credit_debit: profit,
                notes: `Entry: ${document.getElementById('entryTime').value}, Exit: ${document.getElementById('exitTime').value}`
            };
            
            try {
                const response = await fetch('/trades', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(trade)
                });
                
                if (response.ok) {
                    loadTrades();
                }
            } catch (error) {
                console.error('Error saving trade:', error);
            }
        }
        
        // Load trades
        async function loadTrades() {
            try {
                const response = await fetch('/trades');
                const trades = await response.json();
                
                const tradeListDiv = document.getElementById('tradeList');
                if (trades.length === 0) {
                    tradeListDiv.innerHTML = '<p>No trades logged yet.</p>';
                    return;
                }
                
                tradeListDiv.innerHTML = trades.map(trade => {
                    const profitClass = trade.credit_debit >= 0 ? 'profit' : 'loss';
                    return `
                        <div class="trade-entry">
                            <div class="trade-info">
                                <strong>${trade.date} - ${trade.strategy.replace('_', ' ').toUpperCase()}</strong><br>
                                Strikes: ${trade.strikes.join('-')} | 
                                Contracts: ${trade.contracts} | 
                                P/L: <span class="${profitClass}">$${trade.credit_debit.toFixed(2)}</span><br>
                                <small>${trade.notes}</small>
                            </div>
                            <div class="trade-actions">
                                <button class="btn-small btn-danger" onclick="deleteTrade(${trade.id})">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading trades:', error);
            }
        }
        
        // Delete trade
        async function deleteTrade(id) {
            try {
                const response = await fetch(`/trades/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadTrades();
                }
            } catch (error) {
                console.error('Error deleting trade:', error);
            }
        }
        
        // Initialize
        loadCurrentPrice();
        loadTrades();
        
        // Refresh current price every 30 seconds
        setInterval(loadCurrentPrice, 30000);
    </script>
</body>
</html>